<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>fsds_proc.proc_eval_metrics &#8212; Formulation Selector Processing 0.1.3 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=360bc84d"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for fsds_proc.proc_eval_metrics</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">proc_eval_metrics.py</span>

<span class="sd">Helper functions for processing evaluation metrics datasets</span>

<span class="sd">:author: Guy Litt &lt;guy.litt@noaa.gov&gt;</span>
<span class="sd">:description: functions read in yaml schema and standardize metrics datasets</span>
<span class="sd">:note: developed using python v3.12</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="c1">#  Changelog/contributions</span>
<span class="c1">#     2024-07-02 Originally created, GL</span>
<span class="c1">#     2024-07-09 added different file format/dir path options; add file format checkers, GL</span>
<span class="c1">#     2024-08-13 update docstrings, GL</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">netCDF4</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">resources</span> <span class="k">as</span> <span class="n">impresources</span>
<span class="kn">from</span> <span class="nn">fsds_proc</span> <span class="kn">import</span> <span class="n">data</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">compress</span>

<span class="k">def</span> <span class="nf">_proc_flatten_ls_of_dict_keys</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="n">keys_cs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
        <span class="n">keys_cs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">xs</span> <span class="ow">in</span> <span class="n">keys_cs</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_read_std_config</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the standardized categorical mappings used in fsds_proc</span>

<span class="sd">    :return: yaml configuration file mappings as a dict of lists of dicts</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">catg_file</span> <span class="o">=</span> <span class="n">impresources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;fsds_categories.yaml&#39;</span>
    <span class="k">with</span> <span class="n">catg_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">std_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">std_config</span>

<span class="k">def</span> <span class="nf">_conv_ls_dicts_df_long</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;transpose the yaml schema&#39;s converted dataframe into a long format</span>

<span class="sd">    :param config: config file generated by reading in a yaml schema. </span>
<span class="sd">    :type config: dict</span>
<span class="sd">    :seealso: :func:`_read_std_config()`</span>
<span class="sd">    :return: configuration schema converted to a dataframe</span>
<span class="sd">    :rtype: pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert dict of lists into pd.DataFrame</span>
    <span class="n">ls_form</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vv</span><span class="p">:</span>
            <span class="n">df_keys</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">df_keys</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span> <span class="c1"># </span>
            <span class="n">ls_form</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_keys</span><span class="p">)</span>
    <span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ls_form</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># transpose and rename cols</span>
    <span class="n">dft</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">dft</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="s1">&#39;category&#39;</span><span class="p">]</span>
    <span class="n">dft</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dft</span> <span class="o">=</span> <span class="n">dft</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;var&#39;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">dft</span>


<span class="k">def</span> <span class="nf">_proc_check_input_config</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
    <span class="n">std_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;file_io&#39;</span><span class="p">,</span><span class="s1">&#39;col_schema&#39;</span><span class="p">,</span><span class="s1">&#39;formulation_metadata&#39;</span><span class="p">,</span><span class="s1">&#39;references&#39;</span><span class="p">],</span>
    <span class="n">req_col_schema</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gage_id&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_cols&#39;</span><span class="p">],</span>
    <span class="n">req_form_meta</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;dataset_name&#39;</span><span class="p">,</span><span class="s1">&#39;formulation_base&#39;</span><span class="p">,</span><span class="s1">&#39;target_var&#39;</span><span class="p">,</span><span class="s1">&#39;start_date&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;end_date&#39;</span><span class="p">,</span><span class="s1">&#39;cal_status&#39;</span>
        <span class="p">],</span>
    <span class="n">req_file_io</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dir_save&#39;</span><span class="p">,</span> <span class="s1">&#39;save_type&#39;</span><span class="p">,</span><span class="s1">&#39;save_loc&#39;</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check input config file to ensure it contains the minimum expected </span>
<span class="sd">    |    categories</span>

<span class="sd">    :raises ValueError: _description_</span>
<span class="sd">    :raises ValueError: _description_</span>
<span class="sd">    :raises ValueError: _description_</span>
<span class="sd">    :raises ValueError: _description_</span>

<span class="sd">    :seealso: :func: `read_schm_ls_of_dict`</span>
<span class="sd">    :TODO: add further checks after testing more datasets</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Expected standard keys:</span>
    <span class="n">chck_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">std_keys</span><span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chck_dict</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">std_keys</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The provided keys in the input config file&quot;</span>
                        <span class="s2">&quot; should include the following:&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">std_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># required keys defined inside col_schema</span>
    <span class="n">keys_col_schema</span> <span class="o">=</span> <span class="n">_proc_flatten_ls_of_dict_keys</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;col_schema&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">keys_col_schema</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">req_col_schema</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input config file expects the following&quot;</span>
                        <span class="s2">&quot; defined under &#39;col_schema&#39;:&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">req_col_schema</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># required keys defined in formulation_metadata</span>
    <span class="n">keys_form_meta</span> <span class="o">=</span> <span class="n">_proc_flatten_ls_of_dict_keys</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;formulation_metadata&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">keys_form_meta</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">req_form_meta</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input config file expects the following&quot;</span>
                        <span class="s2">&quot; defined under &#39;formulation_metadata&#39;:&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">req_form_meta</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># required keys defined in file_io</span>
    <span class="n">keys_file_io</span> <span class="o">=</span> <span class="n">_proc_flatten_ls_of_dict_keys</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;file_io&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">keys_file_io</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">req_file_io</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The input config file expects the following&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; defined under &#39;formulation_metadata&#39;: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">req_file_io</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="read_schm_ls_of_dict">
<a class="viewcode-back" href="../../index.html#fsds_proc.proc_eval_metrics.read_schm_ls_of_dict">[docs]</a>
<span class="k">def</span> <span class="nf">read_schm_ls_of_dict</span><span class="p">(</span><span class="n">schema_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a dataset&#39;s configuration file designed as a list of dicts</span>

<span class="sd">    :param schema_path: path to the user-created configuration file</span>
<span class="sd">    :type schema_path: str | os.PathLike</span>
<span class="sd">    :return: the filepath to the schema</span>
<span class="sd">    :rtype: pd.DataFrame</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Changelog/contributions</span>
    <span class="c1">#   2024-07-02 Originally created, GL</span>

    <span class="c1"># Load the YAML configuration file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">schema_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="c1"># Run check on expected config formats</span>
    <span class="n">_proc_check_input_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Convert dict of lists into pd.DataFrame</span>
    <span class="n">ls_form</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vv</span><span class="p">:</span>
            <span class="n">ls_form</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ls_form</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_all</span></div>


<span class="k">def</span> <span class="nf">_save_dir_struct</span><span class="p">(</span><span class="n">dir_save</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> 
                        <span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                        <span class="n">save_type</span><span class="p">:</span><span class="nb">str</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
    <span class="c1"># Create a standard directory saving structure (in cases of local filesaving)</span>
    <span class="n">save_dir_base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">dir_save</span><span class="p">)</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;user_data_std&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">dataset_name</span><span class="p">)</span>
    <span class="n">save_dir_base</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">other_save_dirs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">save_type</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span> <span class="ow">or</span> <span class="n">save_type</span> <span class="o">==</span> <span class="s1">&#39;parquet&#39;</span><span class="p">:</span> <span class="c1"># For non-hierachical files</span>
        <span class="c1"># Otherwise single hierarchical files will be saved in lieu of</span>
        <span class="c1"># subdirectories populated w/ .csv files</span>

        <span class="c1"># Design dir structure for writing multiple files</span>
        <span class="n">save_dir_attr</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_dir_base</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;attributes&#39;</span><span class="p">))</span>
        <span class="n">save_dir_eval_metr</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_dir_base</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;metrics&#39;</span><span class="p">))</span>
        <span class="n">save_dir_eval_ts</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_dir_base</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;timeseries&#39;</span><span class="p">))</span>
        <span class="n">save_dir_meta</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_dir_base</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">))</span>
        <span class="n">save_dir_meta_lic</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_dir_meta</span><span class="o">/</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;license&#39;</span><span class="p">))</span>
        <span class="n">save_dir_config</span> <span class="o">=</span>  <span class="n">Path</span><span class="p">(</span><span class="n">save_dir_base</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">))</span>
        <span class="c1"># Generate the expected subdirectories for storing multiple files</span>
        <span class="n">save_dir_attr</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">save_dir_eval_metr</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">save_dir_eval_ts</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">save_dir_meta_lic</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">save_dir_config</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">other_save_dirs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">save_dir_attr</span><span class="p">,</span> 
                            <span class="s1">&#39;eval_metr&#39;</span><span class="p">:</span> <span class="n">save_dir_eval_metr</span><span class="p">,</span> 
                            <span class="s1">&#39;eval_ts&#39;</span> <span class="p">:</span> <span class="n">save_dir_eval_ts</span><span class="p">,</span>
                            <span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="n">save_dir_meta</span><span class="p">,</span> 
                            <span class="s1">&#39;meta_lic&#39;</span><span class="p">:</span> <span class="n">save_dir_meta_lic</span><span class="p">,</span> 
                            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">save_dir_meta</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">save_dir_base</span><span class="p">,</span> <span class="n">other_save_dirs</span>

<span class="k">def</span> <span class="nf">_proc_check_std_fsds_ids</span><span class="p">(</span><span class="nb">vars</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span><span class="s1">&#39;target_var&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run check to ensure that variables are listed in the standardized </span>
<span class="sd">        fsds_categories.yaml</span>

<span class="sd">    :param vars: user-defined variable listing of the anticipated mapped</span>
<span class="sd">        variables (e.g. [&#39;NSE&#39;,&#39;RMSE&#39;])</span>
<span class="sd">    :type vars: list</span>
<span class="sd">    :param category: choose the category of &#39;metric&#39; or &#39;target_var&#39; desired</span>
<span class="sd">        from the fsds standardized categories file. Defaults to &#39;metric&#39;</span>
<span class="sd">    :type category: list, optional</span>
<span class="sd">    :raises ValueError: If at least one of the provided vars is not standard,</span>
<span class="sd">        raises error. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># perform check on input data and convert to list if needed:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">category</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expect </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s1"> to be a single value, not list&#39;</span><span class="p">)</span>

    <span class="c1"># Read in the standardized names</span>
    <span class="n">std_config</span> <span class="o">=</span> <span class="n">_read_std_config</span><span class="p">()</span>
    <span class="n">df_std_config</span> <span class="o">=</span> <span class="n">_conv_ls_dicts_df_long</span><span class="p">(</span><span class="n">std_config</span> <span class="p">)</span>
    <span class="c1"># Subset the categories (e.g. target_variables or metrics)</span>
    <span class="n">sub_std_config</span> <span class="o">=</span> <span class="n">df_std_config</span><span class="p">[</span><span class="n">df_std_config</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">category</span><span class="p">)]</span>

    <span class="c1"># Check to make sure that each metric is inside the standardized names</span>
    <span class="n">bool_chck</span> <span class="o">=</span> <span class="p">[</span><span class="nb">any</span><span class="p">(</span><span class="n">sub_std_config</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">bool_chck</span><span class="p">):</span>
        <span class="n">bad_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="nb">vars</span><span class="p">,[</span><span class="ow">not</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bool_chck</span><span class="p">]))</span>
        <span class="n">allowable_vars</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_std_config</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The following </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s1"> mappings defined in the&#39;</span>
                            <span class="s1">&#39; dataset schema do not correspond to the&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39; standardized </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s1"> names:&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bad_vars</span><span class="p">)</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> Allowable&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39; variables include: </span><span class="si">{</span><span class="n">allowable_vars</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s1"> mappings from the dataset schema match&#39;</span>
                <span class="s1">&#39; expected format.&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_proc_check_input_df</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                         <span class="n">col_schema_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks the input dataset for consistency in expected column format as </span>
<span class="sd">        generated from the yaml config file.</span>

<span class="sd">    :param df: The dataset of interest containing at a minimum catchment ID </span>
<span class="sd">        and evaluation metrics</span>
<span class="sd">    :type df: pd.DataFrame</span>
<span class="sd">    :param col_schema_df: The column schema naming convention ingested from </span>
<span class="sd">        the yaml file corresponding to the dataset.</span>
<span class="sd">    :type col_schema_df: pd.DataFrame</span>
<span class="sd">    :return: wide format df ensuring that the unique identifier for </span>
<span class="sd">        each row is &#39;gage_id&#39;</span>
<span class="sd">    :rtype: pd.DataFrame</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Changelog/contributions</span>
    <span class="c1">#     2024-07-09, originally created, GL</span>
    <span class="c1">#     2024-07-11, bugfix in case index is already named &#39;gage_id&#39;, GL</span>

    <span class="n">gage_id</span> <span class="o">=</span> <span class="n">col_schema_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;gage_id&#39;</span><span class="p">]</span>
    <span class="n">metric_cols</span> <span class="o">=</span> <span class="n">col_schema_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;metric_cols&#39;</span><span class="p">]</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">metric_cols</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>

    <span class="c1"># check that all metric columns in schema file are in input dataframe</span>
    <span class="c1"># extract column names holding metrics</span>
    <span class="n">metric_columns</span> <span class="o">=</span> <span class="n">metric_cols</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">metric_columns</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>

        <span class="c1"># get names of metrics not in df</span>
        <span class="n">missing_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metric_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
            <span class="p">]</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The following metric columns are not in your input&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39; dataframe, df:</span><span class="se">\n</span><span class="s1">    </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_columns</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                      <span class="s1">&#39; </span><span class="se">\n</span><span class="s1">Revise the config file or ensure&#39;</span>
                       <span class="s1">&#39; the input data is in appropriate format</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39; (i.e. wide format for each variable)&#39;</span><span class="p">)</span>
 
    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;gage_id&#39;</span><span class="p">:</span>
        <span class="c1"># Change the name to gage_id   </span>
        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">gage_id</span> <span class="p">:</span> <span class="s1">&#39;gage_id&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;gage_id&#39;</span><span class="p">)):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expecting one df column to be named: </span><span class="si">{</span><span class="n">gage_id</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="s1">&#39; - per the config file. Inspect config file&#39;</span>
                          <span class="s1">&#39; and/or dataframe col names&#39;</span><span class="p">)</span>
        <span class="c1"># Set gage_id as the index</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;gage_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Expect only one gage_id for each row in the data.&#39;</span>
                          <span class="s1">&#39; Convert df to wide format when passing to&#39;</span>
                          <span class="s1">&#39; proc_col_schema(). This could create problems&#39;</span>
                           <span class="s1">&#39; if writing standardized data in hierarchical format.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># We can set the index as &#39;gage_id&#39;</span>
            <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;gage_id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="c1"># Standardize the metrics</span>
    <span class="n">metric_mappings</span> <span class="o">=</span> <span class="n">col_schema_df</span><span class="p">[</span><span class="s1">&#39;metric_mappings&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>

    <span class="c1"># Run check that mappings are part of standardized column naming</span>
    <span class="n">_proc_check_std_fsds_ids</span><span class="p">(</span><span class="n">metric_mappings</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;metric&#39;</span><span class="p">)</span>

    <span class="c1"># rename metrics to the standardized format</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">metric_mappings</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">df</span>

<div class="viewcode-block" id="proc_col_schema">
<a class="viewcode-back" href="../../index.html#fsds_proc.proc_eval_metrics.proc_col_schema">[docs]</a>
<span class="k">def</span> <span class="nf">proc_col_schema</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                    <span class="n">col_schema_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                    <span class="n">dir_save</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process model evaluation metrics into individual standardized files </span>
<span class="sd">        and save a standardized metadata file.</span>

<span class="sd">    :param df: pd.DataFrame type. The dataset of interest containing at a </span>
<span class="sd">        minimum catchment ID and evaluation metrics</span>
<span class="sd">    :type df: pd.DataFrame</span>
<span class="sd">    :param col_schema_df: The column schema naming convention ingested from </span>
<span class="sd">        the yaml file corresponding to the dataset. C</span>
<span class="sd">    :type col_schema_df: pd.DataFrame</span>
<span class="sd">    :param dir_save: Path for saving the standardized metric data file(s)</span>
<span class="sd">        and the metadata file.</span>
<span class="sd">    :type dir_save: str | os.PathLike</span>
<span class="sd">    :raises ValueError: when dir_save does not contain the expected directory</span>
<span class="sd">        structure in cases when saving non-hierarchical file formats</span>
<span class="sd">    :return: dataset of the standardized data/metadata</span>
<span class="sd">    :rtype: xr.Dataset</span>

<span class="sd">    :seealso: :func:`read_schm_ls_of_dict`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Changelog/contributions</span>
    <span class="c1">#  2024-07-02, originally created, GL</span>


    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Standardizing datasets and writing to </span><span class="si">{</span><span class="n">dir_save</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Based on the standardized column schema naming conventions</span>
    <span class="n">dataset_name</span> <span class="o">=</span>  <span class="n">col_schema_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;dataset_name&#39;</span><span class="p">]</span>
    <span class="n">formulation_id</span> <span class="o">=</span>  <span class="n">col_schema_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;formulation_id&#39;</span><span class="p">]</span>
    <span class="n">formulation_base</span> <span class="o">=</span>  <span class="n">col_schema_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;formulation_base&#39;</span><span class="p">]</span>
    <span class="n">save_type</span> <span class="o">=</span> <span class="n">col_schema_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;save_type&#39;</span><span class="p">]</span>
    <span class="n">save_loc</span> <span class="o">=</span> <span class="n">col_schema_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;save_loc&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">formulation_id</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Create formulation_id as a combination of formulation_base and </span>
        <span class="c1"># other elements</span>
        <span class="n">formulation_id</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">filter</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="p">[</span>
                        <span class="n">formulation_base</span><span class="p">,</span>
                        <span class="s1">&#39;_v&#39;</span><span class="p">,</span>
                        <span class="n">col_schema_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;formulation_ver&#39;</span><span class="p">],</span> 
                        <span class="s1">&#39;_&#39;</span><span class="p">,</span>
                        <span class="n">col_schema_df</span><span class="p">[</span><span class="s1">&#39;dataset_name&#39;</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span> 
    
    <span class="c1"># Create the unique filename corresponding to a dataset &amp; formulation</span>
    <span class="n">uniq_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">formulation_id</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="c1"># TODO add cloud or local saving</span>
    <span class="k">if</span> <span class="n">save_loc</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
         <span class="c1"># Optionally creates dir structure  if save_type == &#39;csv&#39; or &#39;parquet&#39;</span>
        <span class="n">_save_dir_base</span><span class="p">,</span> <span class="n">_other_save_dirs</span> <span class="o">=</span> <span class="n">_save_dir_struct</span><span class="p">(</span>
                                                        <span class="n">dir_save</span><span class="p">,</span> 
                                                        <span class="n">dataset_name</span><span class="p">,</span> 
                                                        <span class="n">save_type</span>
                                                        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">save_loc</span> <span class="o">==</span> <span class="s1">&#39;aws&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TODO ensure connect credentials here&quot;</span><span class="p">)</span>
        <span class="c1"># TODO define _save_dir_base here in case .csv are desired in cloud</span>

    <span class="c1"># Run format checker/df renamer on input data based on config file&#39;s entries:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">_proc_check_input_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">col_schema_df</span><span class="p">)</span>

    <span class="c1"># Convert dataframe to the xarray dataset and add metadata:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">col_schema_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># TODO query a database for the lat/lon corresponding to the gage-id if </span>
    <span class="c1"># lat/lon not already provided</span>

    <span class="c1"># Save the standardized dataset</span>
    <span class="k">if</span> <span class="n">save_type</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span> <span class="ow">or</span> <span class="n">save_type</span> <span class="o">==</span> <span class="s1">&#39;parquet&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_other_save_dirs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Expected _save_dir_struct to generate values in _other_save_dirs&#39;</span>
                <span class="p">)</span>

        <span class="c1"># TODO allow output write to a variety of locations (e.g. local/cloud)</span>
        <span class="c1"># Write data in long format</span>
        <span class="n">save_path_eval_metr</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
            <span class="n">_other_save_dirs</span><span class="p">[</span><span class="s1">&#39;eval_metr&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">uniq_filename</span><span class="si">}</span><span class="s1">.csv&#39;</span>
            <span class="p">)</span>
             
        <span class="k">if</span> <span class="n">save_type</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">save_path_eval_metr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span>
                <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">save_path_eval_metr</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="s1">&#39;.parquet&#39;</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="c1"># Write metadata table corresponding to these metric data table(s) </span>
        <span class="c1"># (e.g. startDate, endDate)</span>
        <span class="n">save_path_meta</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
            <span class="n">_other_save_dirs</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">uniq_filename</span><span class="si">}</span><span class="s1">_metadata.csv&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">save_type</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
            <span class="n">col_schema_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">save_path_meta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">col_schema_df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span>
                <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">save_path_meta</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="s1">&#39;.parquet&#39;</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved files within a sub-directory structure inside </span><span class="si">{</span><span class="n">dir_save</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">save_type</span> <span class="o">==</span> <span class="s1">&#39;netcdf&#39;</span><span class="p">:</span>
        <span class="n">save_path_nc</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_save_dir_base</span><span class="o">/</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">uniq_filename</span><span class="si">}</span><span class="s1">.nc&#39;</span><span class="p">))</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_path_nc</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved netcdf file as </span><span class="si">{</span><span class="n">save_path_nc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">save_type</span> <span class="o">==</span> <span class="s1">&#39;zarr&#39;</span><span class="p">:</span>
        <span class="n">save_path_zarr</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_save_dir_base</span><span class="o">/</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">uniq_filename</span><span class="si">}</span><span class="s1">_zarr&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path_zarr</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">save_path_zarr</span><span class="p">)</span> <span class="c1"># Delete any pre-existing zarr data with the same name</span>
                                            <span class="c1"># (BChoat-THIS MAY BE RISKY)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span><span class="n">save_path_zarr</span><span class="p">)</span>   <span class="c1"># Re-write to directory</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved zarr files inside </span><span class="si">{</span><span class="n">save_path_zarr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span> <span class="c1"># Returning not intended use case, but it&#39;s an option</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Formulation Selector Processing</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Guy Litt, Lauren Bolotin, Ben Choat.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>